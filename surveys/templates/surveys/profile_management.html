{% extends "base.html" %}
{% load static %}

{% block title %}Survey Profile Management{% endblock %}

{% block extra_css %}
<style>
    .profile-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: white;
    }
    
    .profile-card.default {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    
    .profile-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .profile-name {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .profile-category {
        color: #666;
        font-size: 0.9rem;
    }
    
    .profile-stats {
        display: flex;
        gap: 1rem;
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #666;
    }
    
    .profile-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .default-badge {
        background-color: #007bff;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    
    .history-item {
        border-left: 3px solid #007bff;
        padding-left: 1rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
    }
    
    .history-date {
        color: #666;
        font-size: 0.9rem;
    }
    
    .completion-bar {
        width: 100%;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .completion-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s ease;
    }
    
    .settings-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    
    .tab-content {
        margin-top: 1rem;
    }
    
    .export-options {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin: 1rem 0;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .alert {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.375rem;
    }
    
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1>Survey Profile Management</h1>
            <p class="text-muted">Manage your saved survey profiles, view history, and configure settings.</p>
        </div>
    </div>
    
    <!-- Alert Messages -->
    <div id="alert-container"></div>
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profiles-tab" data-bs-toggle="tab" data-bs-target="#profiles" type="button" role="tab">
                Saved Profiles
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                Survey History
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab">
                Export Data
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="profileTabContent">
        <!-- Saved Profiles Tab -->
        <div class="tab-pane fade show active" id="profiles" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Saved Profiles</h3>
                <div>
                    <select id="category-filter" class="form-select d-inline-block w-auto">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-primary ms-2" onclick="refreshProfiles()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div id="profiles-container">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading profiles...</p>
                </div>
            </div>
        </div>
        
        <!-- Survey History Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Survey History</h3>
                <div>
                    <select id="history-category-filter" class="form-select d-inline-block w-auto">
                        <option value="">All Categories</option>
                    </select>
                    <button class="btn btn-primary ms-2" onclick="refreshHistory()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div id="history-container">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading history...</p>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings" role="tabpanel">
            <div class="settings-section">
                <h3>Survey Preferences</h3>
                <form id="settings-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="auto-save-responses">
                                <label class="form-check-label" for="auto-save-responses">
                                    Auto-save responses as I progress
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="prefill-from-history">
                                <label class="form-check-label" for="prefill-from-history">
                                    Pre-fill questions based on previous responses
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="email-reminders">
                                <label class="form-check-label" for="email-reminders">
                                    Send email reminders for incomplete surveys
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="data-retention" class="form-label">Data Retention (days)</label>
                                <input type="number" class="form-control" id="data-retention" min="0" max="3650">
                                <div class="form-text">Set to 0 for indefinite retention</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Preferred Categories</label>
                                <div id="preferred-categories">
                                    <!-- Categories will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" class="btn btn-warning" onclick="cleanupOldData()">
                            Cleanup Old Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Export Data Tab -->
        <div class="tab-pane fade" id="export" role="tabpanel">
            <div class="settings-section">
                <h3>Export Survey Data</h3>
                <p class="text-muted">Download your survey data for backup or analysis.</p>
                
                <form id="export-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="export-format" class="form-label">Export Format</label>
                                <select class="form-select" id="export-format">
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="export-category" class="form-label">Category Filter</label>
                                <select class="form-select" id="export-category">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="include-responses" checked>
                                <label class="form-check-label" for="include-responses">
                                    Include survey responses
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="include-profiles" checked>
                                <label class="form-check-label" for="include-profiles">
                                    Include saved profiles
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Save Profile Modal -->
<div id="save-profile-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>Save Survey Profile</h4>
            <span class="close" onclick="closeSaveProfileModal()">&times;</span>
        </div>
        <form id="save-profile-form">
            <div class="mb-3">
                <label for="profile-name" class="form-label">Profile Name</label>
                <input type="text" class="form-control" id="profile-name" required>
            </div>
            
            <div class="mb-3">
                <label for="profile-description" class="form-label">Description (Optional)</label>
                <textarea class="form-control" id="profile-description" rows="3"></textarea>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="set-as-default">
                <label class="form-check-label" for="set-as-default">
                    Set as default profile for this category
                </label>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Profile</button>
                <button type="button" class="btn btn-secondary" onclick="closeSaveProfileModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentSessionId = null;
let categories = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadProfiles();
    loadSettings();
    
    // Set up tab change handlers
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#history') {
                loadHistory();
            }
        });
    });
    
    // Set up form handlers
    document.getElementById('settings-form').addEventListener('submit', saveSettings);
    document.getElementById('export-form').addEventListener('submit', exportData);
    document.getElementById('save-profile-form').addEventListener('submit', saveProfile);
});

// Load categories for filters
async function loadCategories() {
    try {
        const response = await fetch('/api/categories/');
        if (response.ok) {
            categories = await response.json();
            
            // Populate category filters
            const filters = ['category-filter', 'history-category-filter', 'export-category'];
            filters.forEach(filterId => {
                const select = document.getElementById(filterId);
                select.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.slug}">${cat.name}</option>`;
                });
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load user profiles
async function loadProfiles() {
    const container = document.getElementById('profiles-container');
    const categoryFilter = document.getElementById('category-filter').value;
    
    try {
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Loading profiles...</p></div>';
        
        let url = '/surveys/api/profiles/';
        if (categoryFilter) {
            url += `?category=${categoryFilter}`;
        }
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            displayProfiles(data.profiles);
        } else {
            throw new Error('Failed to load profiles');
        }
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Error loading profiles. Please try again.</div>';
        console.error('Error loading profiles:', error);
    }
}

// Display profiles
function displayProfiles(profiles) {
    const container = document.getElementById('profiles-container');
    
    if (profiles.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">No saved profiles found.</p></div>';
        return;
    }
    
    let html = '';
    profiles.forEach(profile => {
        const defaultBadge = profile.is_default ? '<span class="default-badge">Default</span>' : '';
        const lastUsed = profile.last_used ? new Date(profile.last_used).toLocaleDateString() : 'Never';
        
        html += `
            <div class="profile-card ${profile.is_default ? 'default' : ''}">
                <div class="profile-header">
                    <div>
                        <div class="profile-name">${profile.name} ${defaultBadge}</div>
                        <div class="profile-category">${profile.category.name}</div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="applyProfile(${profile.id})">
                            Apply
                        </button>
                        ${!profile.is_default ? `<button class="btn btn-sm btn-outline-secondary" onclick="setDefaultProfile(${profile.id})">Set Default</button>` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProfile(${profile.id})">
                            Delete
                        </button>
                    </div>
                </div>
                
                ${profile.description ? `<p class="text-muted mb-2">${profile.description}</p>` : ''}
                
                <div class="profile-stats">
                    <span>Used: ${profile.usage_count} times</span>
                    <span>Last used: ${lastUsed}</span>
                    <span>Created: ${new Date(profile.created_at).toLocaleDateString()}</span>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Load survey history
async function loadHistory() {
    const container = document.getElementById('history-container');
    const categoryFilter = document.getElementById('history-category-filter').value;
    
    try {
        container.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2">Loading history...</p></div>';
        
        let url = '/surveys/api/history/';
        if (categoryFilter) {
            url += `?category=${categoryFilter}`;
        }
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            displayHistory(data.history);
        } else {
            throw new Error('Failed to load history');
        }
    } catch (error) {
        container.innerHTML = '<div class="alert alert-danger">Error loading history. Please try again.</div>';
        console.error('Error loading history:', error);
    }
}

// Display survey history
function displayHistory(history) {
    const container = document.getElementById('history-container');
    
    if (history.length === 0) {
        container.innerHTML = '<div class="text-center py-4"><p class="text-muted">No survey history found.</p></div>';
        return;
    }
    
    let html = '';
    history.forEach(session => {
        const completionClass = session.survey_completed ? 'bg-success' : 'bg-warning';
        const statusText = session.survey_completed ? 'Completed' : 'In Progress';
        
        html += `
            <div class="history-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${session.category.name}</strong>
                        <span class="badge ${completionClass} ms-2">${statusText}</span>
                    </div>
                    <div class="history-date">
                        ${new Date(session.updated_at).toLocaleDateString()}
                    </div>
                </div>
                
                <div class="completion-bar">
                    <div class="completion-fill" style="width: ${session.completion_percentage}%"></div>
                </div>
                
                <div class="d-flex justify-content-between text-muted small">
                    <span>${session.responses_count} responses</span>
                    <span>${session.completion_percentage.toFixed(1)}% complete</span>
                </div>
                
                ${session.survey_completed ? `
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="showSaveProfileModal(${session.id})">
                            Save as Profile
                        </button>
                        ${session.has_results ? `
                            <a href="/comparison/results/?session=${session.id}" class="btn btn-sm btn-outline-success">
                                View Results
                            </a>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Load user settings
async function loadSettings() {
    try {
        const response = await fetch('/surveys/api/settings/');
        if (response.ok) {
            const settings = await response.json();
            
            document.getElementById('auto-save-responses').checked = settings.auto_save_responses;
            document.getElementById('prefill-from-history').checked = settings.prefill_from_history;
            document.getElementById('email-reminders').checked = settings.email_survey_reminders;
            document.getElementById('data-retention').value = settings.data_retention_days;
            
            // Load preferred categories
            const container = document.getElementById('preferred-categories');
            let html = '';
            categories.forEach(cat => {
                const checked = settings.preferred_categories.some(pref => pref.id === cat.id) ? 'checked' : '';
                html += `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="cat-${cat.id}" value="${cat.id}" ${checked}>
                        <label class="form-check-label" for="cat-${cat.id}">${cat.name}</label>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Save user settings
async function saveSettings(e) {
    e.preventDefault();
    
    const formData = {
        auto_save_responses: document.getElementById('auto-save-responses').checked,
        prefill_from_history: document.getElementById('prefill-from-history').checked,
        email_survey_reminders: document.getElementById('email-reminders').checked,
        data_retention_days: parseInt(document.getElementById('data-retention').value),
        preferred_categories: Array.from(document.querySelectorAll('#preferred-categories input:checked')).map(cb => parseInt(cb.value))
    };
    
    try {
        const response = await fetch('/surveys/api/settings/', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showAlert('Settings saved successfully!', 'success');
        } else {
            throw new Error('Failed to save settings');
        }
    } catch (error) {
        showAlert('Error saving settings. Please try again.', 'danger');
        console.error('Error saving settings:', error);
    }
}

// Export data
async function exportData(e) {
    e.preventDefault();
    
    const format = document.getElementById('export-format').value;
    const category = document.getElementById('export-category').value;
    const includeResponses = document.getElementById('include-responses').checked;
    const includeProfiles = document.getElementById('include-profiles').checked;
    
    const params = new URLSearchParams({
        format: format,
        include_responses: includeResponses,
        include_profiles: includeProfiles
    });
    
    if (category) {
        params.append('category', category);
    }
    
    try {
        const response = await fetch(`/surveys/api/export/?${params}`);
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `survey_data.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showAlert('Data exported successfully!', 'success');
        } else {
            throw new Error('Failed to export data');
        }
    } catch (error) {
        showAlert('Error exporting data. Please try again.', 'danger');
        console.error('Error exporting data:', error);
    }
}

// Profile management functions
async function applyProfile(profileId) {
    // This would need a session ID - for now, show a message
    showAlert('To apply a profile, start a new survey and the system will offer to pre-fill from your saved profiles.', 'info');
}

async function setDefaultProfile(profileId) {
    try {
        const response = await fetch(`/surveys/api/profiles/${profileId}/set-default/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.ok) {
            showAlert('Default profile updated!', 'success');
            loadProfiles();
        } else {
            throw new Error('Failed to set default profile');
        }
    } catch (error) {
        showAlert('Error setting default profile. Please try again.', 'danger');
        console.error('Error setting default profile:', error);
    }
}

async function deleteProfile(profileId) {
    if (!confirm('Are you sure you want to delete this profile?')) {
        return;
    }
    
    try {
        const response = await fetch(`/surveys/api/profiles/${profileId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.ok) {
            showAlert('Profile deleted successfully!', 'success');
            loadProfiles();
        } else {
            throw new Error('Failed to delete profile');
        }
    } catch (error) {
        showAlert('Error deleting profile. Please try again.', 'danger');
        console.error('Error deleting profile:', error);
    }
}

// Modal functions
function showSaveProfileModal(sessionId) {
    currentSessionId = sessionId;
    document.getElementById('save-profile-modal').style.display = 'block';
}

function closeSaveProfileModal() {
    document.getElementById('save-profile-modal').style.display = 'none';
    document.getElementById('save-profile-form').reset();
    currentSessionId = null;
}

async function saveProfile(e) {
    e.preventDefault();
    
    if (!currentSessionId) {
        showAlert('No session selected', 'danger');
        return;
    }
    
    const formData = {
        name: document.getElementById('profile-name').value,
        description: document.getElementById('profile-description').value,
        session_id: currentSessionId,
        set_as_default: document.getElementById('set-as-default').checked
    };
    
    try {
        const response = await fetch('/surveys/api/profiles/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showAlert('Profile saved successfully!', 'success');
            closeSaveProfileModal();
            loadProfiles();
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Failed to save profile');
        }
    } catch (error) {
        showAlert(`Error saving profile: ${error.message}`, 'danger');
        console.error('Error saving profile:', error);
    }
}

// Cleanup old data
async function cleanupOldData() {
    if (!confirm('This will permanently delete old survey data based on your retention settings. Continue?')) {
        return;
    }
    
    try {
        const response = await fetch('/surveys/api/cleanup/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showAlert(`Cleanup completed. ${result.deleted_sessions} old sessions deleted.`, 'success');
            loadHistory();
        } else {
            throw new Error('Failed to cleanup data');
        }
    } catch (error) {
        showAlert('Error cleaning up data. Please try again.', 'danger');
        console.error('Error cleaning up data:', error);
    }
}

// Utility functions
function refreshProfiles() {
    loadProfiles();
}

function refreshHistory() {
    loadHistory();
}

function showAlert(message, type) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('save-profile-modal');
    if (event.target === modal) {
        closeSaveProfileModal();
    }
}
</script>
{% endblock %}