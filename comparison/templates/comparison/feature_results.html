{% extends "base/base.html" %}
{% load static %}

{% block title %}Policy Comparison Results - {{ insurance_type }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">{{ insurance_type }} Policy Comparison Results</h2>
                            <p class="text-muted mb-0">
                                Showing {{ filtered_count }} of {{ total_results }} policies.
                                {% if best_match %}
                                    Your best match scores {{ best_match.get_match_percentage }}%.
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary" onclick="regenerateResults()">
                                <i class="fas fa-sync-alt"></i> Regenerate Results
                            </button>
                            <a href="{% url 'comparison:feature_matrix' survey.id %}" class="btn btn-primary">
                                <i class="fas fa-table"></i> Compare Side-by-Side
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Sorting -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="get" id="filterForm">
                        <div class="row">
                            <!-- General Filters -->
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Minimum Match Score</label>
                                <select name="min_score" class="form-select" onchange="submitFilters()">
                                    <option value="">Any Score</option>
                                    <option value="90" {% if current_filters.min_score == '90' %}selected{% endif %}>90%+</option>
                                    <option value="80" {% if current_filters.min_score == '80' %}selected{% endif %}>80%+</option>
                                    <option value="70" {% if current_filters.min_score == '70' %}selected{% endif %}>70%+</option>
                                    <option value="60" {% if current_filters.min_score == '60' %}selected{% endif %}>60%+</option>
                                    <option value="50" {% if current_filters.min_score == '50' %}selected{% endif %}>50%+</option>
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Organization</label>
                                <select name="organization" class="form-select" onchange="submitFilters()">
                                    <option value="">All Organizations</option>
                                    {% for org in filter_options.organizations %}
                                    <option value="{{ org }}" {% if current_filters.organization == org %}selected{% endif %}>{{ org }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Premium Range</label>
                                <div class="row">
                                    <div class="col-6">
                                        <input type="number" name="min_premium" class="form-control" 
                                               placeholder="Min" value="{{ current_filters.min_premium }}"
                                               onchange="submitFilters()">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" name="max_premium" class="form-control" 
                                               placeholder="Max" value="{{ current_filters.max_premium }}"
                                               onchange="submitFilters()">
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Recommendation</label>
                                <select name="recommendation_category" class="form-select" onchange="submitFilters()">
                                    <option value="">All Categories</option>
                                    {% for category in filter_options.recommendation_categories %}
                                    <option value="{{ category }}" {% if current_filters.recommendation_category == category %}selected{% endif %}>
                                        {{ category|title }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Insurance Type Specific Filters -->
                            {% if survey.insurance_type == 'HEALTH' %}
                            <div class="col-md-3 mb-3">
                                <label class="form-label">In-Hospital Benefits</label>
                                <select name="in_hospital_benefit" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    <option value="true" {% if current_filters.in_hospital_benefit == 'true' %}selected{% endif %}>Required</option>
                                    <option value="false" {% if current_filters.in_hospital_benefit == 'false' %}selected{% endif %}>Not Required</option>
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Out-of-Hospital Benefits</label>
                                <select name="out_hospital_benefit" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    <option value="true" {% if current_filters.out_hospital_benefit == 'true' %}selected{% endif %}>Required</option>
                                    <option value="false" {% if current_filters.out_hospital_benefit == 'false' %}selected{% endif %}>Not Required</option>
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Chronic Medication</label>
                                <select name="chronic_medication" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    <option value="true" {% if current_filters.chronic_medication == 'true' %}selected{% endif %}>Required</option>
                                    <option value="false" {% if current_filters.chronic_medication == 'false' %}selected{% endif %}>Not Required</option>
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Min Annual Limit</label>
                                <input type="number" name="min_annual_limit" class="form-control" 
                                       placeholder="Amount" value="{{ current_filters.min_annual_limit }}"
                                       onchange="submitFilters()">
                            </div>

                            {% elif survey.insurance_type == 'FUNERAL' %}
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Min Cover Amount</label>
                                <input type="number" name="min_cover_amount" class="form-control" 
                                       placeholder="Amount" value="{{ current_filters.min_cover_amount }}"
                                       onchange="submitFilters()">
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Marital Status</label>
                                <select name="marital_status" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    {% for status in filter_options.marital_statuses %}
                                    <option value="{{ status }}" {% if current_filters.marital_status == status %}selected{% endif %}>{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Gender</label>
                                <select name="gender" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    {% for gender in filter_options.genders %}
                                    <option value="{{ gender }}" {% if current_filters.gender == gender %}selected{% endif %}>{{ gender }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3 mb-3">
                                <label class="form-label">Max Waiting Period</label>
                                <select name="max_waiting_period" class="form-select" onchange="submitFilters()">
                                    <option value="">Any</option>
                                    <option value="30" {% if current_filters.max_waiting_period == '30' %}selected{% endif %}>30 days</option>
                                    <option value="60" {% if current_filters.max_waiting_period == '60' %}selected{% endif %}>60 days</option>
                                    <option value="90" {% if current_filters.max_waiting_period == '90' %}selected{% endif %}>90 days</option>
                                    <option value="180" {% if current_filters.max_waiting_period == '180' %}selected{% endif %}>180 days</option>
                                </select>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Sorting and Display Options -->
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">Sort By</label>
                                <select name="sort" class="form-select" onchange="submitFilters()">
                                    <option value="compatibility_rank" {% if current_sort == 'compatibility_rank' %}selected{% endif %}>Best Match First</option>
                                    <option value="compatibility_score" {% if current_sort == 'compatibility_score' %}selected{% endif %}>Highest Score</option>
                                    <option value="premium" {% if current_sort == 'premium' %}selected{% endif %}>Premium</option>
                                    <option value="coverage" {% if current_sort == 'coverage' %}selected{% endif %}>Coverage Amount</option>
                                    <option value="organization" {% if current_sort == 'organization' %}selected{% endif %}>Organization</option>
                                    <option value="feature_matches" {% if current_sort == 'feature_matches' %}selected{% endif %}>Feature Matches</option>
                                    <option value="waiting_period" {% if current_sort == 'waiting_period' %}selected{% endif %}>Waiting Period</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Order</label>
                                <select name="order" class="form-select" onchange="submitFilters()">
                                    <option value="asc" {% if request.GET.order == 'asc' %}selected{% endif %}>Ascending</option>
                                    <option value="desc" {% if request.GET.order == 'desc' %}selected{% endif %}>Descending</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Per Page</label>
                                <select name="page_size" class="form-select" onchange="submitFilters()">
                                    {% for size in page_sizes %}
                                    <option value="{{ size }}" {% if current_page_size == size %}selected{% endif %}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>

                            <div class="col-md-2">
                                <div class="text-muted small">
                                    Showing {{ results.start_index }}-{{ results.end_index }} of {{ filtered_count }}
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Analysis Summary -->
            {% if analysis.ranking_analysis %}
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Analysis Summary</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-primary">{{ analysis.ranking_analysis.best_score|floatformat:1 }}%</h3>
                                <small class="text-muted">Best Match Score</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-success">{{ analysis.ranking_analysis.excellent_matches }}</h3>
                                <small class="text-muted">Excellent Matches</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-info">{{ analysis.ranking_analysis.good_matches }}</h3>
                                <small class="text-muted">Good Matches</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h3 class="text-warning">{{ analysis.ranking_analysis.average_score|floatformat:1 }}%</h3>
                                <small class="text-muted">Average Score</small>
                            </div>
                        </div>
                    </div>
                    
                    {% if analysis.ranking_analysis.insights %}
                    <div class="mt-3">
                        {% for insight in analysis.ranking_analysis.insights %}
                        <div class="alert alert-{{ insight.type }} alert-dismissible fade show" role="alert">
                            {{ insight.message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Results List -->
            <div class="row">
                {% for result in results %}
                <div class="col-lg-6 mb-4">
                    <div class="card h-100 {% if result.compatibility_rank == 1 %}border-primary{% endif %}">
                        {% if result.compatibility_rank == 1 %}
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-crown"></i> Best Match
                        </div>
                        {% endif %}
                        
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="card-title mb-1">{{ result.policy.name }}</h5>
                                    <p class="text-muted mb-0">{{ result.policy.organization.name }}</p>
                                </div>
                                <div class="text-end">
                                    <span class="badge {{ result.get_recommendation_badge_class }} fs-6">
                                        {{ result.get_match_percentage }}% Match
                                    </span>
                                    <div class="small text-muted">Rank #{{ result.compatibility_rank }}</div>
                                </div>
                            </div>

                            <!-- Key Features -->
                            <div class="mb-3">
                                <h6 class="text-success mb-2">
                                    <i class="fas fa-check-circle"></i> Key Matches ({{ result.feature_match_count }})
                                </h6>
                                {% for match in result.get_top_matching_features %}
                                <div class="small text-success mb-1">
                                    <i class="fas fa-check"></i> {{ match.feature }}: {{ match.policy_value }}
                                </div>
                                {% empty %}
                                <div class="small text-muted">No specific feature matches highlighted</div>
                                {% endfor %}
                            </div>

                            {% if result.get_main_concerns %}
                            <div class="mb-3">
                                <h6 class="text-warning mb-2">
                                    <i class="fas fa-exclamation-triangle"></i> Considerations ({{ result.feature_mismatch_count }})
                                </h6>
                                {% for concern in result.get_main_concerns %}
                                <div class="small text-warning mb-1">
                                    <i class="fas fa-exclamation"></i> {{ concern.feature }}: {{ concern.policy_value }}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Policy Details -->
                            <div class="row text-center border-top pt-3">
                                {% if result.policy.base_premium %}
                                <div class="col-4">
                                    <div class="small text-muted">Premium</div>
                                    <div class="fw-bold">R{{ result.policy.base_premium|floatformat:0 }}</div>
                                </div>
                                {% endif %}
                                {% if result.policy.coverage_amount %}
                                <div class="col-4">
                                    <div class="small text-muted">Coverage</div>
                                    <div class="fw-bold">R{{ result.policy.coverage_amount|floatformat:0 }}</div>
                                </div>
                                {% endif %}
                                {% if result.policy.waiting_period_days %}
                                <div class="col-4">
                                    <div class="small text-muted">Waiting Period</div>
                                    <div class="fw-bold">{{ result.policy.waiting_period_days }} days</div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'comparison:feature_result_detail' survey.id result.id %}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-info-circle"></i> View Details
                                </a>
                                <button class="btn btn-primary btn-sm" onclick="selectPolicy({{ result.policy.id }})">
                                    <i class="fas fa-hand-pointer"></i> Select This Policy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-12">
                    <div class="alert alert-warning text-center">
                        <h5>No matching policies found</h5>
                        <p>No policies match your current filter criteria. Try adjusting your filters or contact us for assistance.</p>
                        <button class="btn btn-outline-primary" onclick="clearFilters()">Clear All Filters</button>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if results.has_other_pages %}
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Results pagination">
                    <ul class="pagination">
                        {% if results.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ results.previous_page_number }}">Previous</a>
                        </li>
                        {% endif %}

                        {% for num in results.paginator.page_range %}
                        {% if results.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > results.number|add:'-3' and num < results.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if results.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ results.next_page_number }}">Next</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}

            <!-- Recommendations -->
            {% if analysis.recommendations %}
            <div class="card mt-4">
                <div class="card-body">
                    <h5 class="card-title">Our Recommendations</h5>
                    
                    {% if analysis.recommendations.primary_recommendation %}
                    <div class="alert alert-primary">
                        <h6 class="alert-heading">
                            <i class="fas fa-star"></i> Primary Recommendation
                        </h6>
                        <p class="mb-2">
                            <strong>{{ analysis.recommendations.primary_recommendation.policy.name }}</strong>
                            ({{ analysis.recommendations.primary_recommendation.score|floatformat:1 }}% match)
                        </p>
                        <p class="mb-0">{{ analysis.recommendations.primary_recommendation.reason }}</p>
                    </div>
                    {% endif %}

                    {% if analysis.recommendations.considerations %}
                    <div class="mt-3">
                        <h6>Important Considerations:</h6>
                        <ul class="mb-0">
                            {% for consideration in analysis.recommendations.considerations %}
                            <li>{{ consideration }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function submitFilters() {
    document.getElementById('filterForm').submit();
}

function clearFilters() {
    // Clear all form inputs
    const form = document.getElementById('filterForm');
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(input => {
        if (input.type === 'select-one') {
            input.selectedIndex = 0;
        } else {
            input.value = '';
        }
    });
    
    // Submit the cleared form
    form.submit();
}

function regenerateResults() {
    if (confirm('This will regenerate your comparison results. Continue?')) {
        fetch('{% url "comparison:regenerate_results" survey.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while regenerating results.');
        });
    }
}

function selectPolicy(policyId) {
    // This would typically redirect to a policy application or contact form
    alert('Policy selection functionality would be implemented here for policy ID: ' + policyId);
}
</script>
{% endblock %}