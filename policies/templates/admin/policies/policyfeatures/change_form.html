{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .field-row.hidden-field {
            display: none !important;
        }
        
        .field-row.visible-field {
            display: block;
        }
        
        .required-indicator {
            color: #dc3545;
            font-weight: bold;
        }
        
        .insurance-type-health {
            border-left: 4px solid #28a745;
            padding-left: 10px;
        }
        
        .insurance-type-funeral {
            border-left: 4px solid #6f42c1;
            padding-left: 10px;
        }
        
        .validation-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .validation-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .feature-summary {
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .feature-summary h4 {
            margin-top: 0;
            color: #495057;
        }
        
        .feature-summary ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        
        .feature-summary li {
            margin-bottom: 5px;
        }
        
        .fieldset h2 {
            transition: color 0.3s ease;
        }
        
        .fieldset.collapsed .collapse-toggle:before {
            content: "▶ ";
        }
        
        .fieldset:not(.collapsed) .collapse-toggle:before {
            content: "▼ ";
        }
    </style>
{% endblock %}

{% block admin_change_form_document_ready %}
    {{ block.super }}
    <script src="{% static 'policies/admin/js/policy_features_admin.js' %}"></script>
    
    <script>
        (function($) {
            'use strict';
            
            $(document).ready(function() {
                // Add feature summary box
                addFeatureSummary();
                
                // Add validation status indicator
                addValidationStatus();
                
                // Add insurance type styling
                addInsuranceTypeStyling();
            });
            
            function addFeatureSummary() {
                var insuranceType = $('#id_insurance_type').val();
                if (!insuranceType) return;
                
                var summaryHtml = '<div class="feature-summary">' +
                    '<h4>Feature Completion Status</h4>' +
                    '<div id="feature-completion-status"></div>' +
                    '</div>';
                
                $('.form-row.field-insurance_type').after(summaryHtml);
                updateFeatureSummary();
                
                // Update summary when fields change
                $('input, select').change(function() {
                    updateFeatureSummary();
                });
            }
            
            function updateFeatureSummary() {
                var insuranceType = $('#id_insurance_type').val();
                var statusDiv = $('#feature-completion-status');
                
                if (!statusDiv.length) return;
                
                var requiredFields = [];
                var filledFields = [];
                
                if (insuranceType === 'HEALTH') {
                    requiredFields = [
                        {name: 'annual_limit_per_member', label: 'Annual Limit per Member'},
                        {name: 'monthly_household_income', label: 'Monthly Household Income'},
                        {name: 'in_hospital_benefit', label: 'In-Hospital Benefit'},
                        {name: 'out_hospital_benefit', label: 'Out-of-Hospital Benefit'},
                        {name: 'chronic_medication_availability', label: 'Chronic Medication Coverage'}
                    ];
                } else if (insuranceType === 'FUNERAL') {
                    requiredFields = [
                        {name: 'cover_amount', label: 'Cover Amount'},
                        {name: 'marital_status_requirement', label: 'Marital Status Requirement'},
                        {name: 'gender_requirement', label: 'Gender Requirement'},
                        {name: 'monthly_net_income', label: 'Monthly Net Income'}
                    ];
                }
                
                requiredFields.forEach(function(field) {
                    var input = $('#id_' + field.name);
                    var value = input.val();
                    var isChecked = input.is(':checked');
                    
                    if ((input.attr('type') === 'checkbox' && isChecked !== false) || 
                        (input.attr('type') !== 'checkbox' && value && value.trim() !== '')) {
                        filledFields.push(field.label);
                    }
                });
                
                var completionPercentage = requiredFields.length > 0 ? 
                    Math.round((filledFields.length / requiredFields.length) * 100) : 0;
                
                var statusClass = completionPercentage === 100 ? 'validation-success' : 
                                 completionPercentage >= 50 ? 'feature-summary' : 'validation-error';
                
                statusDiv.html(
                    '<div class="' + statusClass + '">' +
                    '<strong>Completion: ' + completionPercentage + '%</strong> ' +
                    '(' + filledFields.length + '/' + requiredFields.length + ' fields completed)' +
                    '</div>'
                );
            }
            
            function addValidationStatus() {
                // This would integrate with server-side validation
                // For now, just add a placeholder for validation messages
                var validationDiv = '<div id="validation-messages" style="margin-bottom: 15px;"></div>';
                $('.form-row.field-insurance_type').before(validationDiv);
            }
            
            function addInsuranceTypeStyling() {
                $('#id_insurance_type').change(function() {
                    var insuranceType = $(this).val();
                    var form = $('.form-row');
                    
                    form.removeClass('insurance-type-health insurance-type-funeral');
                    
                    if (insuranceType === 'HEALTH') {
                        form.addClass('insurance-type-health');
                    } else if (insuranceType === 'FUNERAL') {
                        form.addClass('insurance-type-funeral');
                    }
                });
                
                // Trigger on page load
                $('#id_insurance_type').trigger('change');
            }
            
        })(django.jQuery);
    </script>
{% endblock %}